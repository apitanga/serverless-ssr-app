name: Sync Infrastructure Config

on:
  # Trigger manually after TFC apply
  workflow_dispatch:

  # Or trigger automatically after infra changes
  push:
    branches: [main]
    paths:
      - 'infra/**/*.tf'
      - 'infra/**/*.tfvars'

# Required to update GitHub variables
permissions:
  contents: read
  actions: write # Required to update repository variables

jobs:
  sync-config:
    name: Update INFRA_OUTPUTS_JSON Variable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ">= 1.5.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Get Infrastructure Outputs
        id: outputs
        working-directory: infra
        run: |
          # Get all outputs as JSON
          terraform output -json > /tmp/infra-outputs.json

          # Show what we got
          echo "ðŸ“‹ Infrastructure outputs retrieved:"
          cat /tmp/infra-outputs.json | jq 'keys'

      - name: Update GitHub Variable
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "ðŸ”„ Updating INFRA_OUTPUTS_JSON variable..."

          # Read JSON and encode for single-line storage
          INFRA_JSON=$(cat /tmp/infra-outputs.json | jq -c .)

          # Update or create the variable
          gh variable set INFRA_OUTPUTS_JSON --body "$INFRA_JSON"

          echo "âœ… Variable updated successfully!"

      - name: Verify Update
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "âœ… INFRA_OUTPUTS_JSON was last updated:"
          gh variable list | grep INFRA_OUTPUTS_JSON || echo "Variable exists (no timestamp shown)"
          echo ""
          echo "ðŸŽ¯ Next deployment will use the latest infrastructure configuration"
